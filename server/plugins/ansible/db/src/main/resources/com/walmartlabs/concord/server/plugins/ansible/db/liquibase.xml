<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet id="ansible-10000" author="ybrigo@gmail.com">
        <!-- migration from pre-1.18.0 -->
        <preConditions onFail="MARK_RAN">
            <not>
                <and>
                    <changeSetExecuted id="99100" author="ybrigo@gmail.com" changeLogFile="com/walmartlabs/concord/server/db/v0.99.0.xml"/>
                    <changeSetExecuted id="1110000" author="ybrigo@gmail.com" changeLogFile="com/walmartlabs/concord/server/db/v1.11.0.xml"/>
                </and>
            </not>
        </preConditions>
        <createTable tableName="ANSIBLE_HOSTS">
            <column name="INSTANCE_ID" type="uuid">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="INSTANCE_CREATED_AT" type="timestamp">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="HOST" type="varchar(1024)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="HOST_GROUP" type="varchar(1024)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="EVENT_SEQ" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="STATUS" type="varchar(32)">
                <constraints nullable="false"/>
            </column>
            <column name="DURATION" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="RETRY_COUNT" type="int" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="ansible-10001" author="ybrigo@gmail.com">
        <createTable tableName="ANSIBLE_PLAYBOOK_STATS">
            <column name="INSTANCE_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="INSTANCE_CREATED_AT" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="PLAYBOOK_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="STARTED_AT" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="HOST_COUNT" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="PLAY_COUNT" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="TOTAL_WORK" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="ansible-10002" author="ybrigo@gmail.com">
        <createTable tableName="ANSIBLE_PLAYBOOK_RESULT">
            <column name="INSTANCE_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="INSTANCE_CREATED_AT" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="PLAYBOOK_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="STATUS" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="ansible-10003" author="ybrigo@gmail.com">
        <createTable tableName="ANSIBLE_PLAY_STATS">
            <column name="INSTANCE_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="INSTANCE_CREATED_AT" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="PLAYBOOK_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="PLAY_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="PLAY_NAME" type="varchar(1024)">
                <constraints nullable="true"/>
            </column>
            <column name="PLAY_ORDER" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="HOST_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="TASK_COUNT" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="FINISHED_TASK_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="ansible-10004" author="ybrigo@gmail.com">
        <createTable tableName="ANSIBLE_TASK_STATS">
            <column name="INSTANCE_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="INSTANCE_CREATED_AT" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="PLAYBOOK_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="PLAY_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="TASK_ID" type="uuid">
                <constraints nullable="false"/>
            </column>
            <column name="TASK_NAME" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="TASK_ORDER" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="TASK_TYPE" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="OK_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="FAILED_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="UNREACHABLE_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="SKIPPED_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="RUNNING_COUNT" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="ansible-10005" author="ybrigo@gmail.com">
        <addColumn tableName="ANSIBLE_HOSTS">
            <column name="PLAYBOOK_ID" type="uuid">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="ansible-10006" author="ybrigo@gmail.com">
        <createIndex tableName="ANSIBLE_PLAYBOOK_STATS" indexName="IDX_A_PLAYBOOK_STATS">
            <column name="INSTANCE_ID"/>
            <column name="INSTANCE_CREATED_AT"/>
        </createIndex>

        <createIndex tableName="ANSIBLE_PLAYBOOK_RESULT" indexName="IDX_A_PLAYBOOK_RESULT">
            <column name="INSTANCE_ID"/>
            <column name="INSTANCE_CREATED_AT"/>
            <column name="PLAYBOOK_ID"/>
        </createIndex>

        <createIndex tableName="ANSIBLE_PLAY_STATS" indexName="IDX_A_PLAY_STATS">
            <column name="INSTANCE_ID"/>
            <column name="INSTANCE_CREATED_AT"/>
            <column name="PLAYBOOK_ID"/>
        </createIndex>

        <createIndex tableName="ANSIBLE_TASK_STATS" indexName="IDX_A_TASK_STATS">
            <column name="INSTANCE_ID"/>
            <column name="INSTANCE_CREATED_AT"/>
            <column name="PLAY_ID"/>
        </createIndex>
    </changeSet>

    <changeSet id="ansible-10007" author="ybrigo@gmail.com">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from pg_inherits
                join pg_class parent ON pg_inherits.inhparent = parent.oid
                join pg_class child ON pg_inherits.inhrelid = child.oid
                join pg_namespace nmsp_parent ON nmsp_parent.oid = parent.relnamespace
                join pg_namespace nmsp_child ON nmsp_child.oid = child.relnamespace
                where parent.relname = 'ansible_hosts'
            </sqlCheck>
        </preConditions>

        <dropPrimaryKey tableName="ANSIBLE_HOSTS"/>
        <addPrimaryKey tableName="ANSIBLE_HOSTS" columnNames="INSTANCE_ID, INSTANCE_CREATED_AT, HOST, HOST_GROUP, PLAYBOOK_ID"/>
    </changeSet>
</databaseChangeLog>
